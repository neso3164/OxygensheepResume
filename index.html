<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>張念祥的履歷</title>
    <meta name="description" content="個人履歷與作品集">
    <link rel="stylesheet" href="assets/styles.css">
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#111827">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      /* Scoped styles for the mini chat widget */
      .chat-toggle{position:fixed;right:20px;bottom:20px;padding:10px 14px;border:0;border-radius:999px;background:#111;color:#ffd400;font-weight:700;box-shadow:0 8px 24px rgba(0,0,0,.18);cursor:pointer;z-index:9999;font-family:"Microsoft JhengHei", system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", Arial}
      .chat-window{position:fixed;right:20px;bottom:80px;width:340px;max-height:70vh;background:#0b0b0b;border:1px solid #222;border-radius:16px;box-shadow:0 12px 32px rgba(0,0,0,.4);display:none;overflow:hidden;z-index:9999;font-family:"Microsoft JhengHei", system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", Arial;color:#f5f5f5}
      .chat-cover{width:100%;aspect-ratio:1/1;object-fit:cover;display:block;border-bottom:1px solid #222;background:#111}
      .chat-header{padding:10px 12px;background:#111;color:#ffd400;font-weight:700}
      .chat-body{padding:12px;height:42vh;overflow:auto;background:#0f0f0f}
      .msg{margin:8px 0;line-height:1.5}
      .msg.user{text-align:right;color:#e8e8e8}
      .msg.assistant{text-align:left;color:#d1d5db}
      .chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid #222;background:#0b0b0b}
      .chat-input input{flex:1;padding:10px 12px;border:1px solid #2b2b2b;border-radius:10px;background:#151515;color:#f3f4f6}
      .chat-input input::placeholder{color:#777}
      .chat-input button{padding:10px 12px;border:0;border-radius:10px;background:#111;color:#ffd400;font-weight:700;cursor:pointer}
      .hint{font-size:12px;color:#9ca3af;margin-top:4px}
    </style>
  </head>
  <body>
    <noscript style="color:#b91c1c; padding:8px 12px; display:block; background:#fff3f3; border-bottom:1px solid #fca5a5">此網站需要啟用 JavaScript 才能運作 / JavaScript is required.</noscript>
    <div id="app" class="app-root">
      <!-- Header and routed views will render here by JS -->
    </div>

    <script type="module" src="src/app.js"></script>
    <!-- Mini chat widget -->
    <button class="chat-toggle" aria-controls="chat" aria-expanded="false">豬仔AI小窗</button>

    <div class="chat-window" id="chat" role="dialog" aria-label="豬仔AI小視窗">
      <img class="chat-cover" id="chat-cover" alt="聊天視窗封面">
      <div class="chat-header">豬仔AI小助手</div>
      <div class="chat-body" id="log"></div>
      <div class="chat-input">
        <input id="inp" placeholder="輸入訊息…" aria-label="輸入訊息">
        <button id="send">送出</button>
      </div>
      <div class="hint" style="padding:0 12px 10px;">還是直接寄EMAIL給我更詳盡喔~</div>
    </div>

    <script>
      (function(){
        const API = "https://hook.us2.make.com/q4rqle6snt5nl5t64rel8eaker22wq88"; // Webhook URL
        const chat   = document.getElementById('chat');
        const toggle = document.querySelector('.chat-toggle');
        const log    = document.getElementById('log');
        const inp    = document.getElementById('inp');
        const send   = document.getElementById('send');
        const cover  = document.getElementById('chat-cover');

        // Load cover image with multiple fallbacks (supports filename without extension)
        (function loadCover(){
          if (!cover) return;
          const base = 'assets/PIGAI';
          const candidates = [
            `${base}`,
            `${base}.png`, `${base}.PNG`, `${base}.jpg`, `${base}.JPG`, `${base}.jpeg`, `${base}.webp`
          ];
          let i = 0;
          const tryNext = () => {
            if (i >= candidates.length){
              // final fallback: hide cover if all fail
              cover.style.display = 'none';
              return;
            }
            cover.src = candidates[i++];
          };
          cover.onerror = tryNext;
          cover.onload = () => { /* ok */ };
          tryNext();
        })();

        function setExpanded(isOpen){
          toggle.setAttribute('aria-expanded', String(isOpen));
        }

        toggle.addEventListener('click', () => {
          const isOpen = chat.style.display === 'block';
          chat.style.display = isOpen ? 'none' : 'block';
          setExpanded(!isOpen);
          if(!isOpen) inp.focus();
        });

        function push(role, text){
          const div = document.createElement('div');
          div.className = 'msg ' + role;
          div.textContent = text;
          log.appendChild(div);
          log.scrollTop = log.scrollHeight;
        }

        async function ask(){
          const text = inp.value.trim();
          if(!text) return;
          inp.value = '';
          push('user', text);
          send.disabled = true;

          try{
            // Try POST JSON first
            let replyText = '';
            try {
              const res = await fetch(API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
              });
              // Some webhooks return text/plain. Try JSON, then text.
              const contentType = res.headers.get('content-type') || '';
              if(!res.ok) throw new Error('HTTP ' + res.status);
              if(contentType.includes('application/json')){
                const data = await res.json();
                replyText = (data && (data.reply || data.message || data.text)) || '';
              } else {
                const t = await res.text();
                // If text contains a JSON-looking object, try parse
                try { const j = JSON.parse(t); replyText = j.reply || j.message || j.text || t; }
                catch { replyText = t; }
              }
            } catch (e) {
              // Likely CORS/preflight blocked. Fallback to GET with query (simple request)
              const url = API + '?message=' + encodeURIComponent(text);
              const res2 = await fetch(url, { method: 'GET' });
              const ctype2 = res2.headers.get('content-type') || '';
              if(!res2.ok) throw new Error('HTTP ' + res2.status);
              if(ctype2.includes('application/json')){
                const data2 = await res2.json();
                replyText = (data2 && (data2.reply || data2.message || data2.text)) || '';
              } else {
                const t2 = await res2.text();
                try { const j2 = JSON.parse(t2); replyText = j2.reply || j2.message || j2.text || t2; }
                catch { replyText = t2; }
              }
            }

            push('assistant', replyText || '（沒有回覆內容）');
          }catch(err){
            console.error(err);
            push('assistant', '（出錯了，稍後再試）');
          }finally{
            send.disabled = false;
            inp.focus();
          }
        }

        send.addEventListener('click', ask);
        inp.addEventListener('keydown', e => { if(e.key === 'Enter') ask(); });
      })();
    </script>
  </body>
  </html>


